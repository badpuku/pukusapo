# 基本概念 - ロールと権限を理解しよう

## 🎯 この章で学ぶこと

- ロール（役割）とは何か
- 権限（パーミッション）とは何か
- なぜロール機能が必要なのか
- 実際のWebアプリでの使用例

## 🏢 身近な例で理解しよう

### 会社の組織で考えてみる

```
会社の例：
┌─────────────┐
│   社長      │ ← すべての決定権を持つ
├─────────────┤
│   部長      │ ← 部署の管理権限を持つ
├─────────────┤
│   一般社員   │ ← 基本的な業務のみ
└─────────────┘
```

**これをWebアプリに置き換えると...**

```
Webアプリの例：
┌─────────────┐
│   管理者     │ ← すべての機能を使える
├─────────────┤
│ モデレーター │ ← 一部の管理機能を使える
├─────────────┤
│ 一般ユーザー │ ← 基本機能のみ使える
└─────────────┘
```

## 🔑 基本用語の説明

### 1. ロール（Role）= 役割

**ロール**は「その人の役割・立場」を表します。

```typescript
// ロールの例
const roles = [
  "user", // 一般ユーザー
  "moderator", // モデレーター
  "admin", // 管理者
];
```

### 2. 権限（Permission）= できること

**権限**は「具体的に何ができるか」を表します。

```typescript
// 権限の例
const permissions = [
  "profile.read", // プロフィールを見る
  "profile.update", // プロフィールを編集する
  "users.delete", // ユーザーを削除する
  "content.moderate", // コンテンツを管理する
];
```

### 3. ロールと権限の関係

```
ロール「管理者」の場合：
┌─────────────┐
│    admin    │
└─────────────┘
        │
        ├── profile.read ✅
        ├── profile.update ✅
        ├── users.delete ✅
        └── content.moderate ✅

ロール「一般ユーザー」の場合：
┌─────────────┐
│    user     │
└─────────────┘
        │
        ├── profile.read ✅
        ├── profile.update ✅
        ├── users.delete ❌
        └── content.moderate ❌
```

## 🌟 なぜロール機能が必要？

### ❌ ロール機能がない場合の問題

```typescript
// 悪い例：すべてのユーザーが管理機能にアクセス可能
function deleteUser(userId: string) {
  // 誰でもユーザーを削除できてしまう！
  return database.users.delete(userId);
}
```

### ✅ ロール機能がある場合の安全性

```typescript
// 良い例：管理者のみがアクセス可能
function deleteUser(userId: string, currentUser: User) {
  // 管理者権限をチェック
  if (!hasRole(currentUser, "admin")) {
    throw new Error("権限がありません");
  }

  return database.users.delete(userId);
}
```

## 🎮 実際の使用例

### ブログサイトの場合

```
┌─────────────────────────────────────────────┐
│                ブログサイト                  │
├─────────────────────────────────────────────┤
│ 読者（user）                                │
│ ✅ 記事を読む                               │
│ ✅ コメントを書く                           │
│ ❌ 記事を削除する                           │
├─────────────────────────────────────────────┤
│ 編集者（moderator）                         │
│ ✅ 記事を読む                               │
│ ✅ コメントを書く                           │
│ ✅ 不適切なコメントを削除する               │
│ ❌ ユーザーアカウントを削除する             │
├─────────────────────────────────────────────┤
│ 管理者（admin）                             │
│ ✅ すべての機能                             │
│ ✅ ユーザー管理                             │
│ ✅ システム設定                             │
└─────────────────────────────────────────────┘
```

### ECサイトの場合

```
┌─────────────────────────────────────────────┐
│                ECサイト                      │
├─────────────────────────────────────────────┤
│ 顧客（customer）                            │
│ ✅ 商品を見る                               │
│ ✅ 注文する                                 │
│ ❌ 商品価格を変更する                       │
├─────────────────────────────────────────────┤
│ 店舗スタッフ（staff）                       │
│ ✅ 注文を確認する                           │
│ ✅ 在庫を管理する                           │
│ ❌ 売上レポートを見る                       │
├─────────────────────────────────────────────┤
│ 店長（manager）                             │
│ ✅ すべての店舗機能                         │
│ ✅ 売上レポート                             │
│ ❌ システム全体の設定                       │
└─────────────────────────────────────────────┘
```

## 🔄 権限チェックの流れ

```
1. ユーザーがアクションを実行しようとする
   ↓
2. システムがユーザーのロールを確認
   ↓
3. そのロールに必要な権限があるかチェック
   ↓
4. 権限がある → アクション実行
   権限がない → エラーメッセージ
```

### 具体的なコード例

```typescript
// 1. ユーザーのロールを取得
const userRole = getCurrentUserRole();

// 2. 必要な権限をチェック
const canDeleteUser = hasPermission(userRole, "users.delete");

// 3. 権限に基づいて処理を分岐
if (canDeleteUser) {
  deleteUser(userId);
} else {
  showError("この操作を行う権限がありません");
}
```

## 💡 重要なポイント

### 1. **最小権限の原則**

ユーザーには**必要最小限の権限のみ**を与える

```typescript
// ❌ 悪い例：すべての権限を与える
const userPermissions = ["*"]; // 危険！

// ✅ 良い例：必要な権限のみ
const userPermissions = ["profile.read", "profile.update"];
```

### 2. **階層的な権限**

上位のロールは下位のロールの権限を含む

```
admin ⊃ moderator ⊃ user

admin: すべての権限
moderator: userの権限 + 管理権限の一部
user: 基本権限のみ
```

### 3. **権限の粒度**

権限は**具体的で明確**にする

```typescript
// ❌ 曖昧な権限
"manage_users";

// ✅ 明確な権限
"users.create";
"users.read";
"users.update";
"users.delete";
```

## 🤔 よくある質問

### Q1: ロールと権限の違いは？

**A:** ロールは「役割・立場」、権限は「具体的にできること」です。

- ロール：管理者、一般ユーザー
- 権限：削除する、編集する、閲覧する

### Q2: ユーザーは複数のロールを持てる？

**A:** 設計によります。シンプルなアプリでは1つ、複雑なシステムでは複数のロールを持つことがあります。

### Q3: 権限は後から変更できる？

**A:** はい。ロールに割り当てられた権限は管理者が変更できるように設計されています。

---

**前へ**: [ドキュメント一覧](./README.md) ←  
**次へ**: [データベース設計](./02-database-design.md) →
